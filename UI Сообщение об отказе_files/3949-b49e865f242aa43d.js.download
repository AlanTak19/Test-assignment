"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3949],{33949:(e,t,r)=>{r.r(t),r.d(t,{NewChatButton:()=>f});var a=r(69160),i=r(10556),n=r(73627),s=r(80459),o=r(59667),l=r(18396),c=r(68648),d=r(79995),u=r(59700),h=r(24815);function f(e){let{variant:t="text",className:r,buttonVariant:f,onButtonClick:p,...g}=e,v=(0,h.N)("newChatButton"),{stopLlmResponse:m}=(0,n.e)(),w=(0,d.useCallback)(()=>{m(),(0,i.j)("ClickNewChat"),null==p||p()},[m,p]);return"logo"===t?(0,a.jsx)(l.z,{asChild:!0,className:(0,u.cn)("size-8 border-none hover:bg-transparent focus:bg-transparent focus-visible:bg-transparent has-[>svg]:p-0 [&>svg]:size-8",r),variant:"ghost",...g,children:(0,a.jsxs)(c.f,{"data-testid":"header-logo",href:"/",onClick:w,children:[(0,a.jsx)(s.T,{"aria-hidden":!0,className:"size-10"}),(0,a.jsx)("span",{className:"sr-only",children:v("newChat")})]})}):"icon"===t?(0,a.jsx)(l.z,{asChild:!0,className:(0,u.cn)("hover:bg-gray-150 size-8 shadow-[0px_1px_2px_0px_hsla(0,0%,0%,0.04)] has-[>svg]:px-0",r),tooltip:{side:"right",content:v("newChat"),sideOffset:8},variant:"secondary",...g,children:(0,a.jsxs)(c.f,{href:"/chat",onClick:w,children:[(0,a.jsx)("span",{"aria-hidden":!0,children:(0,a.jsx)(o.v,{})}),(0,a.jsx)("span",{className:"sr-only",children:v("newChat")})]})}):"collapsible"===t?(0,a.jsx)(l.z,{asChild:!0,className:(0,u.cn)("collapsed:w-8 hover:bg-gray-150 focus:bg-gray-150 focus-visible:bg-gray-150 bg-background transition-sidebar relative h-8 w-full overflow-hidden border-none px-2 text-gray-900 shadow-sm",r),size:"sm",...g,children:(0,a.jsx)(c.f,{href:"/chat",onClick:w,children:(0,a.jsxs)("div",{className:"collapsed:left-0 collapsed:translate-x-2 transition-sidebar absolute inset-2 left-[calc((var(--sidebar-width)-128px)/2)] flex w-fit items-center justify-center gap-2 whitespace-nowrap",children:[(0,a.jsx)("div",{className:"collapsed:opacity-100 transition-sidebar opacity-0 ease-in-out",children:(0,a.jsx)(o.v,{})}),(0,a.jsx)("span",{children:v("newChat")})]})})}):(0,a.jsx)(l.z,{asChild:!0,className:r,size:"sm",variant:f,...g,children:(0,a.jsx)(c.f,{href:"/chat",onClick:w,children:v("newChat")})})}},68648:(e,t,r)=>{r.d(t,{f:()=>o});var a=r(69160),i=r(70900),n=r(48531),s=r(14905);function o(e){let{href:t,...r}=e,o=(0,s.useRouter)();return(0,a.jsx)(n.default,{...r,href:t,onMouseEnter:()=>{o.prefetch(t,{kind:i.PrefetchKind.FULL})},onTouchStart:()=>{o.prefetch(t,{kind:i.PrefetchKind.FULL})},prefetch:!0})}r(79995)},80459:(e,t,r)=>{r.d(t,{T:()=>i});var a=r(69160);function i(e){return(0,a.jsxs)("svg",{fill:"currentColor",viewBox:"0 0 40 20",xmlns:"http://www.w3.org/2000/svg",...e,children:[(0,a.jsx)("path",{d:"M23.3919 0H32.9188C36.7819 0 39.9136 3.13165 39.9136 6.99475V16.0805H36.0006V6.99475C36.0006 6.90167 35.9969 6.80925 35.9898 6.71766L26.4628 16.079C26.4949 16.08 26.5272 16.0805 26.5595 16.0805H36.0006V19.7762H26.5595C22.6964 19.7762 19.4788 16.6139 19.4788 12.7508V3.68923H23.3919V12.7508C23.3919 12.9253 23.4054 13.0977 23.4316 13.2668L33.1682 3.6995C33.0861 3.6927 33.003 3.68923 32.9188 3.68923H23.3919V0Z"}),(0,a.jsx)("path",{d:"M13.7688 19.0956L0 3.68759H5.53933L13.6231 12.7337V3.68759H17.7535V17.5746C17.7535 19.6705 15.1654 20.6584 13.7688 19.0956Z"})]})}},80685:(e,t,r)=>{r.d(t,{I:()=>d,v:()=>c});var a=r(79995),i=r(97077),n=r(86032),s=r(98985),o=r(80679);function l(e,t){let{activeScopeSlug:r,user:l,isTeam:c}=(0,s.PK)(),{data:d,isLoading:u,mutate:h}=(0,n.ZP)(["chat:".concat(e),r],async t=>{let[,r]=t;if(!l||!r)return;let a="";if(c){let e=new URLSearchParams;e.set("team",r),a="?".concat(e.toString())}try{let t="history"===e?"/chat/api/history".concat(a):"/chat/api/favorites".concat(a),r=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}});if(!r.ok)throw Error("Failed to load chat ".concat(e));let i=await r.json();if(!i)throw Error("Failed to load chat ".concat(e));return i.map(e=>({...e,updatedAt:new Date(e.updatedAt)}))}catch(t){if(t==o.WY)return;throw i.Am.error("Failed to load chat ".concat(e)),t}},{fallbackData:t}),f=(0,a.useCallback)((e,t)=>{let r=e(d||[]);h(r,{optimisticData:r,revalidate:t})},[d,h]);return{data:d,isLoading:u,revalidate:(0,a.useCallback)(()=>h(),[h]),setData:f}}function c(e){return l("history",e)}function d(e){return l("favorites",e)}},19773:(e,t,r)=>{r.d(t,{Gb:()=>d,Ur:()=>u,vp:()=>c});var a=r(86032),i=r(79995),n=r(96261),s=r(30758),o=r(97077),l=r(98985);function c(){let{data:e,mutate:t}=(0,a.ZP)("project:id");return{projectId:e,setProjectId:t}}function d(){let{data:e,mutate:t}=(0,a.ZP)("projects:for-user"),r=(0,i.useCallback)(e=>{t(t=>({selectedProjectId:e,projects:(null==t?void 0:t.projects)||[]})),(0,n.d8)(s.YW,e||"",{path:"/",maxAge:s.fh})},[t]);return{projects:(null==e?void 0:e.projects)||[],selectedProjectId:(null==e?void 0:e.selectedProjectId)||null,setSelectedProjectId:r}}function u(){let{projectId:e}=c(),{activeScopeSlug:t}=(0,l.PK)(),{data:r,mutate:n,error:s}=(0,a.ZP)(["project:sources",e],async()=>{if(!e)throw Error("No project ID");let r=new URLSearchParams;r.set("projectId",e),t&&r.set("scope",t);let a=await fetch("/chat/api/projects/sources?".concat(r.toString()),{method:"GET",headers:{"Content-Type":"application/json"}});if(!a.ok)throw Error("Failed to load project sources");let i=await a.json();if(!i)throw Error("Failed to load project sources");return i},{revalidateIfStale:!1,revalidateOnFocus:!1,revalidateOnReconnect:!1,revalidateOnMount:!1,refreshInterval:e=>(null==e?void 0:e.some(e=>"processing"===e.status&&!e.isOptimistic))?500:0}),d=!!s;(0,i.useEffect)(()=>{d&&o.Am.error("Failed to load project sources")},[d]);let u=(0,i.useCallback)(()=>{n()},[n]);return{sources:r||[],setSources:n,revalidateSources:u}}},85784:(e,t,r)=>{r.d(t,{IT:()=>i,sE:()=>n});var a=r(63026);let i=()=>(0,a.Ox)(21),n=()=>(0,a.Ox)(21)},83224:(e,t,r)=>{r.d(t,{kG:()=>i});var a=r(30758);function i(e){var t,r,i;let n={isLlmError:!1,isRetried:!1,errorCategory:void 0};if("string"==typeof e){n.isLlmError=e.startsWith(a.xZ),n.isRetried=e.endsWith(a.Bo);let t=null!==(r=e.split(":")[1])&&void 0!==r?r:"default";n.errorCategory=t}else if(null===(t=e.finishReason)||void 0===t?void 0:t.includes("provider_server_error")){let t=e.finishReason.startsWith("retry_provider_server_error"),r=t||!!e.finishReason.startsWith("provider_server_error");if(n.isLlmError=r,n.isRetried=t,r){let t=null!==(i=e.finishReason.split(":")[1])&&void 0!==i?i:"default";n.errorCategory=t}}return n}},55807:(e,t,r)=>{r.d(t,{d:()=>i});var a=r(79995);function i(e){let t=(0,a.useRef)(e);return(0,a.useEffect)(()=>{t.current=e},[e]),t}},73627:(e,t,r)=>{r.d(t,{W:()=>R,e:()=>A});var a=r(79995);let i=r(68612).Ue({});var n=r(80685),s=r(20419),o=r(97077),l=r(12885),c=r(99706),d=r(55807),u=r(14905),h=r(76811),f=r(24194),p=r(83224),g=r(66018),v=r(80679),m=r(70934),w=r(10556),y=r(43097),j=r(19773),b=r(85784),x=r(98985),C=r(66637);async function I(e){return new Promise((t,r)=>{let a=new FileReader;a.onload=e=>{var r;t(null===(r=e.target)||void 0===r?void 0:r.result)},a.onerror=e=>r(e),a.readAsDataURL(e)})}let E=new Map;function k(e){let t=E.get(e);t&&(t.abort(),E.delete(e))}var L=r(92104);let R="opt-retry-message";function A(){let{onSubmit:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{activeScope:t,user:r}=(0,x.PK)(),A=(0,c.sd)(),F=(0,c.OK)(),{chatId:_,messages:N,chatIdToken:P,activeForkKey:K}=(0,s.RN)(),M=(0,s.ql)(),{setMetadata:T}=(0,h.xN)(),{setDraft:O}=(0,y.no)(),{quote:U,setQuote:z}=(0,h.B1)(),{revalidate:V,setData:D}=(0,n.v)(),H=(0,d.d)(e),W=(0,d.d)(N),[Z,G]=(0,g.Uf)(),{selectedProjectId:q}=(0,j.Gb)(),B=(0,u.useRouter)();return{submit:(0,a.useCallback)(async(e,a)=>{if(!(null==r?void 0:r.id))return;let n=r.id,s=[...W.current],c=!1;try{var d,u,h;let r,s;let o=W.current;await G();let m=function(e,t){let r=E.get(e);r&&r.abort();let a=new AbortController;E.set(e,a);let i=a.signal;return i.onabort=()=>{E.delete(e),null==t||t()},i}(_,()=>M({isLoading:!1,isStreaming:!1,isContinuing:!1})),j=[],x="attachments"in e?e.attachments:void 0;if(x){if(x instanceof FileList)for(let e of Array.from(x)){let{name:t,type:r,size:a}=e,i=await I(e);j.push({name:t,contentType:r,url:i,size:a})}else if(Array.isArray(x))for(let e of x){let{name:t,url:r,contentType:a,size:i}=e;j.push({name:t,contentType:a,url:r,size:i})}else throw Error(v.X2)}let k=0===o.length||void 0!==a;a||null===(h=H.current)||void 0===h||h.call(H),M({isLoading:!0}),k?(window.history.pushState(null,"","/chat/".concat(_)),T({isEmpty:!1}),(0,y.Vw)({chatId:void 0})):(0,y.Vw)({chatId:_}),O(null);let N=function(e){let{input:t,chatSubmitData:r,quote:a,messages:i,activeForkKey:n,authorId:s}=e;switch(r.action){case"continue":case"retry":{let e;if(!n)throw Error(v.qq);let t=r.assistantMessageId,a=i.find(e=>"id"in e&&e.id===t&&"assistant"===e.role);if(!a||"assistant"!==a.role||!a.parentId)throw Error(v.Hi);"continue"===r.action&&(e={...a,continuingMessageId:t});let s="retry"===r.action?(0,f.zj)(n,t,R+(0,b.IT)()):n;return{action:{type:r.action,userMessageId:a.parentId,assistantMessageId:t},continueAssistantMessage:e,newActiveForkKey:s}}case"edit":{if(!t)throw Error(v.ph);if(!n)throw Error(v.hs);let e=t?S(t,a):null,s=r.userMessageId,o=i.find(e=>e.id===s);if((null==o?void 0:o.role)!=="user")throw Error(v.Hi);let l=(0,b.IT)();return{newUserMessage:{role:"user",content:e,id:l,attachments:o.attachments,parentId:o.parentId,type:"message",authorId:o.authorId},action:{type:"edit",userMessageId:o.id},newActiveForkKey:(0,f.zj)(n,o.id,l)}}case"new":{let e=t?S(t,a):null;if(1===i.length&&"user"===i[0].role)return{isFromQParam:!0,newUserMessage:i[0],newActiveForkKey:(0,f.ty)(void 0,i[0].id)};if(!t&&(!r.attachments||0===r.attachments.length))throw Error(v.ph);let o=(0,b.IT)(),l=(0,f.ty)(n,o);return{newUserMessage:{role:"user",content:e||"",id:o,attachments:r.attachments,parentId:(0,f.w$)(n),type:"message",authorId:s},newActiveForkKey:l}}default:throw Error(v.aK)}}({input:"input"in e?e.input:void 0,chatSubmitData:e,quote:U,messages:o,activeForkKey:K,authorId:n});if(!N){M({isLoading:!1,isStreaming:!1,isContinuing:!1});return}z(null),M({prefillOptions:{query:void 0,projectId:void 0},isContinuing:"continue"===e.action,isLoading:"continue"!==e.action,isStreaming:"continue"===e.action}),"new"!==e.action&&((null===(u=N.newUserMessage)||void 0===u?void 0:null===(d=u.attachments)||void 0===d?void 0:d.length)||0)>0&&j.push(...N.newUserMessage.attachments);let{action:Z,continueAssistantMessage:J,newUserMessage:Q,newActiveForkKey:X}=N,Y=[...o];Q&&!N.isFromQParam&&Y.push(Q),M({messages:Y,activeForkKey:N.newActiveForkKey});let $={};if(a)r=a.readableStream.getReader(),$=a.headers;else{let a=t&&!(0,C.u)(t)?t.slug:void 0,i=await fetch("/chat/api/chat",{method:"POST",body:JSON.stringify({message:null==Q?void 0:Q.content,messageId:null==Q?void 0:Q.id,chatId:_,chatIdToken:P,isNew:k,forkKey:null==X?void 0:X.slice(0,-1),..."new"===e.action&&k?{projectId:q}:{},action:Z,...j.length>0?{attachments:j}:{},team:a}),headers:{"Content-Type":"application/json"},signal:m});if(!i.ok||!i.body){let e=await i.text();throw Error(e)}$=Object.fromEntries(i.headers.entries()),r=i.body.getReader()}let ee=$["x-v0-project-id"],et=$["x-v0-project-name"],er=$["x-v0-project-color"],ea=$["x-v0-project-icon"];ee&&et&&T({project:{projectId:ee,name:et,settings:{color:er,icon:ea}}});let ei=$["x-v0-user-message-id"];if(!ei)throw Error(v.ic);J&&(Y=Y.filter(e=>"assistant"!==e.role||e.id!==J.id));let en=!1,es=new TextDecoder,eo=$["x-v0-response-message-id"];if(!eo)throw Error(v.v1);let el=function(e){let{responseMessageId:t,action:r,newActiveForkKey:a,userMessageServerId:i}=e;if((null==r?void 0:r.type)==="continue"||(null==r?void 0:r.type)==="retry")return(0,f.KK)(a,t);let n=(0,f.KK)(a,i);return(0,f.ty)(n,t)}({responseMessageId:eo,action:Z,newActiveForkKey:X,userMessageServerId:ei}),ec=[],ed="continue"===e.action,eu=()=>ed?null==J?void 0:J.content:ec;function g(e){m.throwIfAborted();try{var t;let r=JSON.parse(e);ec=function(e,t){let r=i.clone(e);if(Array.isArray(t)&&9===t[1]&&9===t[2]){let e=t[0].slice(0,-1),a=t[0].slice(-1),i=r;for(let t of e){if("string"==typeof i[t])return i[t]+=a,r;i=i[t]}}return i.patch(r,t),r}(ec,r),ed&&(null===(t=ec.find(e=>"markdown"===(0,l.bm)(e)))||void 0===t?void 0:t[1])&&(ed=!1);let a=(0,l.to)(ec,eo),o=(0,l._9)(ec);if(!en&&"string"==typeof o.title&&o.title&&(en=!0,T({title:o.title}),k&&o.title&&D(e=>[{title:o.title,chatId:_,updatedAt:new Date,shareable:!1,privacy:"private",favorite:!1,optimistic:!0,authorId:n},...e.filter(e=>e.chatId!==_)],!1)),s={parentId:ei,role:"assistant",content:eu(),context:o.docsContext,id:eo,blocks:a.map(e=>e.id),streaming:!1===ed,finishReason:o.finishReason||null,hasDiffs:a.some(e=>void 0!==e.diffInfo),usage:o.usage,modelId:o.modelId,continuingMessageId:null==J?void 0:J.id,type:"message"},M({messages:[...Y,s],isLoading:!1,isStreaming:!0}),1===a.length){let e=a[a.length-1];return A(e),a}}catch(t){(0,w.j)("ChatHookError",{chatId:_,errorCode:v.XR,errorMsg:"Failed to read row: ".concat(e)}),"production"!==L.env.VERCEL_ENV&&console.error(t,"Error reading row:",e)}}s={parentId:ei,role:"assistant",content:eu(),id:eo,streaming:void 0===J,finishReason:null,hasDiffs:!1,continuingMessageId:null==J?void 0:J.id,type:"message"},M({messages:[...Y,s],activeForkKey:el,saveLeafMessageId:!0}),c=!0;let eh="",ef=!1;for(;;){m.throwIfAborted();let{done:e,value:t}=await r.read();if(e)break;let a=eh+(t instanceof Uint8Array?es.decode(t):t),{isLlmError:i,isRetried:n,errorCategory:o="default"}=(0,p.kG)(a);if(i)throw M({messages:[...Y,{...s,finishReason:n?"retry_provider_server_error:".concat(o):"provider_server_error:".concat(o)}]}),Error(v.xm);let l=a.split("\n");for(let e=0;e<l.length-1;e++){let t=g(l[e]);!ef&&(null==t?void 0:t.length)&&(ef=!0,F(!0,t[t.length-1]))}eh=l[l.length-1]}eh&&g(eh),M({messages:[...Y,{...s,streaming:!1}],isStreaming:!1,isContinuing:!1,initialStreamPromise:void 0}),k&&(B.refresh(),V()),E.delete(_)}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;M({isLoading:!1,isStreaming:!1,isContinuing:!1,initialStreamPromise:void 0,prefillOptions:{query:void 0,projectId:void 0},...c?{}:{activeForkKey:K,messages:s}}),k(_),(0,m.R)(e,B,"Failed to submit message. Start a new chat, retry, or edit your message.")||o.Am.error("An unexpected error occurred. Please refresh the page and try again."),c||0!==s.length||B.push("/chat")}},[r,K,W,G,_,M,O,U,z,H,T,t,P,q,D,A,F,B,V]),stopLlmResponse:(0,a.useCallback)(()=>{let e=W.current;if(k(_),e.length>0){let t=e[e.length-1];"assistant"===t.role&&M({messages:[...e.slice(0,-1),{...t,streaming:!1}]})}setTimeout(()=>M({isStreaming:!1,isLoading:!1}),0)},[_,W,M])}}function S(e,t){return t?"".concat(t.split("\n").map(e=>"> "+e).join("\n"),"\n\n").concat(e):e}}}]);