"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3949],{33949:(e,t,r)=>{r.r(t),r.d(t,{NewChatButton:()=>f});var i=r(69160),n=r(10556),a=r(3751),s=r(80459),o=r(59667),l=r(18396),c=r(68648),d=r(79995),u=r(59700),h=r(24815);function f(e){let{variant:t="text",className:r,buttonVariant:f,onButtonClick:p,...v}=e,g=(0,h.N)("newChatButton"),{stopLlmResponse:m}=(0,a.e)(),w=(0,d.useCallback)(()=>{m(),(0,n.j)("ClickNewChat"),null==p||p()},[m,p]);return"logo"===t?(0,i.jsx)(l.z,{asChild:!0,className:(0,u.cn)("size-8 border-none hover:bg-transparent focus:bg-transparent focus-visible:bg-transparent has-[>svg]:p-0 [&>svg]:size-8",r),variant:"ghost",...v,children:(0,i.jsxs)(c.f,{"data-testid":"header-logo",href:"/",onClick:w,children:[(0,i.jsx)(s.T,{"aria-hidden":!0,className:"size-10"}),(0,i.jsx)("span",{className:"sr-only",children:g("newChat")})]})}):"icon"===t?(0,i.jsx)(l.z,{asChild:!0,className:(0,u.cn)("hover:bg-gray-150 size-8 shadow-[0px_1px_2px_0px_hsla(0,0%,0%,0.04)] has-[>svg]:px-0",r),tooltip:{side:"right",content:g("newChat"),sideOffset:8},variant:"secondary",...v,children:(0,i.jsxs)(c.f,{href:"/chat",onClick:w,children:[(0,i.jsx)("span",{"aria-hidden":!0,children:(0,i.jsx)(o.v,{})}),(0,i.jsx)("span",{className:"sr-only",children:g("newChat")})]})}):"collapsible"===t?(0,i.jsx)(l.z,{asChild:!0,className:(0,u.cn)("collapsed:w-8 hover:bg-gray-150 focus:bg-gray-150 focus-visible:bg-gray-150 bg-background transition-sidebar relative h-8 w-full overflow-hidden border-none px-2 text-gray-900 shadow-sm",r),size:"sm",...v,children:(0,i.jsx)(c.f,{href:"/chat",onClick:w,children:(0,i.jsxs)("div",{className:"collapsed:left-0 collapsed:translate-x-2 transition-sidebar absolute inset-2 left-[calc((var(--sidebar-width)-128px)/2)] flex w-fit items-center justify-center gap-2 whitespace-nowrap",children:[(0,i.jsx)("div",{className:"collapsed:opacity-100 transition-sidebar opacity-0 ease-in-out",children:(0,i.jsx)(o.v,{})}),(0,i.jsx)("span",{children:g("newChat")})]})})}):(0,i.jsx)(l.z,{asChild:!0,className:r,size:"sm",variant:f,...v,children:(0,i.jsx)(c.f,{href:"/chat",onClick:w,children:g("newChat")})})}},68648:(e,t,r)=>{r.d(t,{f:()=>o});var i=r(69160),n=r(70900),a=r(48531),s=r(14905);function o(e){let{href:t,...r}=e,o=(0,s.useRouter)();return(0,i.jsx)(a.default,{...r,href:t,onMouseEnter:()=>{o.prefetch(t,{kind:n.PrefetchKind.FULL})},onTouchStart:()=>{o.prefetch(t,{kind:n.PrefetchKind.FULL})},prefetch:!0})}r(79995)},80459:(e,t,r)=>{r.d(t,{T:()=>n});var i=r(69160);function n(e){return(0,i.jsxs)("svg",{fill:"currentColor",viewBox:"0 0 40 20",xmlns:"http://www.w3.org/2000/svg",...e,children:[(0,i.jsx)("path",{d:"M23.3919 0H32.9188C36.7819 0 39.9136 3.13165 39.9136 6.99475V16.0805H36.0006V6.99475C36.0006 6.90167 35.9969 6.80925 35.9898 6.71766L26.4628 16.079C26.4949 16.08 26.5272 16.0805 26.5595 16.0805H36.0006V19.7762H26.5595C22.6964 19.7762 19.4788 16.6139 19.4788 12.7508V3.68923H23.3919V12.7508C23.3919 12.9253 23.4054 13.0977 23.4316 13.2668L33.1682 3.6995C33.0861 3.6927 33.003 3.68923 32.9188 3.68923H23.3919V0Z"}),(0,i.jsx)("path",{d:"M13.7688 19.0956L0 3.68759H5.53933L13.6231 12.7337V3.68759H17.7535V17.5746C17.7535 19.6705 15.1654 20.6584 13.7688 19.0956Z"})]})}},80685:(e,t,r)=>{r.d(t,{I:()=>d,v:()=>c});var i=r(79995),n=r(97077),a=r(86032),s=r(98985),o=r(80679);function l(e,t){let{activeScopeSlug:r,user:l,isTeam:c}=(0,s.PK)(),{data:d,isLoading:u,mutate:h}=(0,a.ZP)(["chat:".concat(e),r],async t=>{let[,r]=t;if(!l||!r)return;let i="";if(c){let e=new URLSearchParams;e.set("team",r),i="?".concat(e.toString())}try{let t="history"===e?"/chat/api/history".concat(i):"/chat/api/favorites".concat(i),r=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}});if(!r.ok)throw Error("Failed to load chat ".concat(e));let n=await r.json();if(!n)throw Error("Failed to load chat ".concat(e));return n.map(e=>({...e,updatedAt:new Date(e.updatedAt)}))}catch(t){if(t==o.WY)return;throw n.Am.error("Failed to load chat ".concat(e)),t}},{fallbackData:t}),f=(0,i.useCallback)((e,t)=>{let r=e(d||[]);h(r,{optimisticData:r,revalidate:t})},[d,h]);return{data:d,isLoading:u,revalidate:(0,i.useCallback)(()=>h(),[h]),setData:f}}function c(e){return l("history",e)}function d(e){return l("favorites",e)}},19773:(e,t,r)=>{r.d(t,{Gb:()=>d,Ur:()=>u,vp:()=>c});var i=r(86032),n=r(79995),a=r(96261),s=r(30758),o=r(97077),l=r(98985);function c(){let{data:e,mutate:t}=(0,i.ZP)("project:id");return{projectId:e,setProjectId:t}}function d(){let{data:e,mutate:t}=(0,i.ZP)("projects:for-user"),r=(0,n.useCallback)(e=>{t(t=>({selectedProjectId:e,projects:(null==t?void 0:t.projects)||[]})),(0,a.d8)(s.YW,e||"",{path:"/",maxAge:s.fh})},[t]);return{projects:(null==e?void 0:e.projects)||[],selectedProjectId:(null==e?void 0:e.selectedProjectId)||null,setSelectedProjectId:r}}function u(){let{projectId:e}=c(),{activeScopeSlug:t}=(0,l.PK)(),{data:r,mutate:a,error:s}=(0,i.ZP)(["project:sources",e],async()=>{if(!e)throw Error("No project ID");let r=new URLSearchParams;r.set("projectId",e),t&&r.set("scope",t);let i=await fetch("/chat/api/projects/sources?".concat(r.toString()),{method:"GET",headers:{"Content-Type":"application/json"}});if(!i.ok)throw Error("Failed to load project sources");let n=await i.json();if(!n)throw Error("Failed to load project sources");return n},{revalidateIfStale:!1,revalidateOnFocus:!1,revalidateOnReconnect:!1,revalidateOnMount:!1,refreshInterval:e=>(null==e?void 0:e.some(e=>"processing"===e.status&&!e.isOptimistic))?500:0}),d=!!s;(0,n.useEffect)(()=>{d&&o.Am.error("Failed to load project sources")},[d]);let u=(0,n.useCallback)(()=>{a()},[a]);return{sources:r||[],setSources:a,revalidateSources:u}}},85784:(e,t,r)=>{r.d(t,{IT:()=>n,sE:()=>a});var i=r(63026);let n=()=>(0,i.Ox)(21),a=()=>(0,i.Ox)(21)},83224:(e,t,r)=>{r.d(t,{kG:()=>n});var i=r(30758);function n(e){var t,r,n;let a={isLlmError:!1,isRetried:!1,errorCategory:void 0};if("string"==typeof e){a.isLlmError=e.startsWith(i.xZ),a.isRetried=e.endsWith(i.Bo);let t=null!==(r=e.split(":")[1])&&void 0!==r?r:"default";a.errorCategory=t}else if(null===(t=e.finishReason)||void 0===t?void 0:t.includes("provider_server_error")){let t=e.finishReason.startsWith("retry_provider_server_error"),r=t||!!e.finishReason.startsWith("provider_server_error");if(a.isLlmError=r,a.isRetried=t,r){let t=null!==(n=e.finishReason.split(":")[1])&&void 0!==n?n:"default";a.errorCategory=t}}return a}},55807:(e,t,r)=>{r.d(t,{d:()=>n});var i=r(79995);function n(e){let t=(0,i.useRef)(e);return(0,i.useEffect)(()=>{t.current=e},[e]),t}},3751:(e,t,r)=>{r.d(t,{W:()=>A,e:()=>S});var i=r(79995);let n=r(68612).Ue({});var a=r(80685),s=r(20419),o=r(97077),l=r(12885),c=r(99706),d=r(55807),u=r(14905),h=r(76811),f=r(24194),p=r(83224),v=r(66018),g=r(80679),m=r(70934),w=r(10556),y=r(43097),j=r(19773),b=r(85784),x=r(98985),C=r(66637);async function I(e){return new Promise((t,r)=>{let i=new FileReader;i.onload=e=>{var r;t(null===(r=e.target)||void 0===r?void 0:r.result)},i.onerror=e=>r(e),i.readAsDataURL(e)})}let E=new Map;function k(e){let t=E.get(e);t&&(t.abort(),E.delete(e))}var R=r(86032),L=r(92104);let A="opt-retry-message";function S(){let{onSubmit:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{activeScope:t,user:r}=(0,x.PK)(),S=(0,c.sd)(),P=(0,c.OK)(),{chatId:_,messages:N,chatIdToken:K,activeForkKey:M}=(0,s.RN)(),T=(0,s.ql)(),{setMetadata:O}=(0,h.xN)(),{setDraft:U}=(0,y.no)(),{quote:z,setQuote:V}=(0,h.B1)(),{revalidate:D,setData:H}=(0,a.v)(),Z=(0,d.d)(e),W=(0,d.d)(N),[B,G]=(0,v.Uf)(),{selectedProjectId:q}=(0,j.Gb)(),J=function(){let e=(0,c.zi)();return function(e,t){let r=function(e){let t=(0,i.useRef)(),{data:r,mutate:n}=(0,R.ZP)(e);return(0,i.useEffect)(()=>{r||n(t)},[r,n]),r}(e);return(0,i.useEffect)(()=>{r&&(r.current=t)},[r,t]),r}("activeBlockIdRef",null==e?void 0:e.id)}(),Q=(0,u.useRouter)();return{submit:(0,i.useCallback)(async(e,i)=>{if(!(null==r?void 0:r.id))return;let a=r.id,s=[...W.current],c=!1;try{var d,u,h;let r,s;let o=W.current;await G();let m=function(e,t){let r=E.get(e);r&&r.abort();let i=new AbortController;E.set(e,i);let n=i.signal;return n.onabort=()=>{E.delete(e),null==t||t()},n}(_,()=>T({isLoading:!1,isStreaming:!1,isContinuing:!1})),j=[],x="attachments"in e?e.attachments:void 0;if(x){if(x instanceof FileList)for(let e of Array.from(x)){let{name:t,type:r,size:i}=e,n=await I(e);j.push({name:t,contentType:r,url:n,size:i})}else if(Array.isArray(x))for(let e of x){let{name:t,url:r,contentType:i,size:n}=e;j.push({name:t,contentType:i,url:r,size:n})}else throw Error(g.X2)}let k=0===o.length||void 0!==i;i||null===(h=Z.current)||void 0===h||h.call(Z),T({isLoading:!0}),k?(window.history.pushState(null,"","/chat/".concat(_)),O({isEmpty:!1}),(0,y.Vw)({chatId:void 0})):(0,y.Vw)({chatId:_}),U(null);let R=function(e){let{input:t,chatSubmitData:r,quote:i,messages:n,activeForkKey:a,authorId:s}=e;switch(r.action){case"continue":case"retry":{let e;if(!a)throw Error(g.qq);let t=r.assistantMessageId,i=n.find(e=>"id"in e&&e.id===t&&"assistant"===e.role);if(!i||"assistant"!==i.role||!i.parentId)throw Error(g.Hi);"continue"===r.action&&(e={...i,continuingMessageId:t});let s="retry"===r.action?(0,f.zj)(a,t,A+(0,b.IT)()):a;return{action:{type:r.action,userMessageId:i.parentId,assistantMessageId:t},continueAssistantMessage:e,newActiveForkKey:s}}case"edit":{if(!t)throw Error(g.ph);if(!a)throw Error(g.hs);let e=t?F(t,i):null,s=r.userMessageId,o=n.find(e=>e.id===s);if((null==o?void 0:o.role)!=="user")throw Error(g.Hi);let l=(0,b.IT)();return{newUserMessage:{role:"user",content:e,id:l,attachments:o.attachments,parentId:o.parentId,type:"message",authorId:o.authorId},action:{type:"edit",userMessageId:o.id},newActiveForkKey:(0,f.zj)(a,o.id,l)}}case"new":{let e=t?F(t,i):null;if(1===n.length&&"user"===n[0].role)return{isFromQParam:!0,newUserMessage:n[0],newActiveForkKey:(0,f.ty)(void 0,n[0].id)};if(!t&&(!r.attachments||0===r.attachments.length))throw Error(g.ph);let o=(0,b.IT)(),l=(0,f.ty)(a,o);return{newUserMessage:{role:"user",content:e||"",id:o,attachments:r.attachments,parentId:(0,f.w$)(a),type:"message",authorId:s},newActiveForkKey:l}}default:throw Error(g.aK)}}({input:"input"in e?e.input:void 0,chatSubmitData:e,quote:z,messages:o,activeForkKey:M,authorId:a});if(!R){T({isLoading:!1,isStreaming:!1,isContinuing:!1});return}V(null),T({prefillOptions:{query:void 0,projectId:void 0},isContinuing:"continue"===e.action,isLoading:"continue"!==e.action,isStreaming:"continue"===e.action}),"new"!==e.action&&((null===(u=R.newUserMessage)||void 0===u?void 0:null===(d=u.attachments)||void 0===d?void 0:d.length)||0)>0&&j.push(...R.newUserMessage.attachments);let{action:N,continueAssistantMessage:B,newUserMessage:X,newActiveForkKey:Y}=R,$=[...o];X&&!R.isFromQParam&&$.push(X),T({messages:$,activeForkKey:R.newActiveForkKey});let ee={};if(i)r=i.readableStream.getReader(),ee=i.headers;else{let i=t&&!(0,C.u)(t)?t.slug:void 0,n=await fetch("/chat/api/chat",{method:"POST",body:JSON.stringify({message:null==X?void 0:X.content,messageId:null==X?void 0:X.id,chatId:_,chatIdToken:K,isNew:k,forkKey:null==Y?void 0:Y.slice(0,-1),..."new"===e.action&&k?{projectId:q}:{},action:N,...j.length>0?{attachments:j}:{},team:i}),headers:{"Content-Type":"application/json"},signal:m});if(!n.ok||!n.body){let e=await n.text();throw Error(e)}ee=Object.fromEntries(n.headers.entries()),r=n.body.getReader()}let et=ee["x-v0-project-id"],er=ee["x-v0-project-name"],ei=ee["x-v0-project-color"],en=ee["x-v0-project-icon"];et&&er&&O({project:{projectId:et,name:er,settings:{color:ei,icon:en}}});let ea=ee["x-v0-user-message-id"];if(!ea)throw Error(g.ic);B&&($=$.filter(e=>"assistant"!==e.role||e.id!==B.id));let es=!1,eo=new TextDecoder,el=ee["x-v0-response-message-id"];if(!el)throw Error(g.v1);let ec=function(e){let{responseMessageId:t,action:r,newActiveForkKey:i,userMessageServerId:n}=e;if((null==r?void 0:r.type)==="continue"||(null==r?void 0:r.type)==="retry")return(0,f.KK)(i,t);let a=(0,f.KK)(i,n);return(0,f.ty)(a,t)}({responseMessageId:el,action:N,newActiveForkKey:Y,userMessageServerId:ea}),ed=[],eu="continue"===e.action,eh=()=>eu?null==B?void 0:B.content:ed;function v(e){m.throwIfAborted();try{var t;let r=JSON.parse(e);ed=function(e,t){let r=n.clone(e);if(Array.isArray(t)&&9===t[1]&&9===t[2]){let e=t[0].slice(0,-1),i=t[0].slice(-1),n=r;for(let t of e){if("string"==typeof n[t])return n[t]+=i,r;n=n[t]}}return n.patch(r,t),r}(ed,r),eu&&(null===(t=ed.find(e=>"markdown"===(0,l.bm)(e)))||void 0===t?void 0:t[1])&&(eu=!1);let i=(0,l.to)(ed,el),o=(0,l._9)(ed);if(!es&&"string"==typeof o.title&&o.title&&(es=!0,O({title:o.title}),k&&o.title&&H(e=>[{title:o.title,chatId:_,updatedAt:new Date,shareable:!1,privacy:"private",favorite:!1,optimistic:!0,authorId:a},...e.filter(e=>e.chatId!==_)],!1)),s={parentId:ea,role:"assistant",content:eh(),context:o.docsContext,id:el,blocks:i.map(e=>e.id),streaming:!1===eu,finishReason:o.finishReason||null,hasDiffs:i.some(e=>void 0!==e.diffInfo),usage:o.usage,modelId:o.modelId,continuingMessageId:null==B?void 0:B.id,type:"message"},T({messages:[...$,s],isLoading:!1,isStreaming:!0}),1===i.length){let e=i[i.length-1];return e.id===(null==J?void 0:J.current)&&S(e),i}}catch(t){(0,w.j)("ChatHookError",{chatId:_,errorCode:g.XR,errorMsg:"Failed to read row: ".concat(e)}),"production"!==L.env.VERCEL_ENV&&console.error(t,"Error reading row:",e)}}s={parentId:ea,role:"assistant",content:eh(),id:el,streaming:void 0===B,finishReason:null,hasDiffs:!1,continuingMessageId:null==B?void 0:B.id,type:"message"},T({messages:[...$,s],activeForkKey:ec,saveLeafMessageId:!0}),c=!0;let ef="",ep=!1;for(;;){m.throwIfAborted();let{done:e,value:t}=await r.read();if(e)break;let i=ef+(t instanceof Uint8Array?eo.decode(t):t),{isLlmError:n,isRetried:a,errorCategory:o="default"}=(0,p.kG)(i);if(n)throw T({messages:[...$,{...s,finishReason:a?"retry_provider_server_error:".concat(o):"provider_server_error:".concat(o)}]}),Error(g.xm);let l=i.split("\n");for(let e=0;e<l.length-1;e++){let t=v(l[e]);!ep&&(null==t?void 0:t.length)&&(ep=!0,P(!0,t[t.length-1]))}ef=l[l.length-1]}ef&&v(ef),T({messages:[...$,{...s,streaming:!1}],isStreaming:!1,isContinuing:!1,initialStreamPromise:void 0}),k&&(Q.refresh(),D()),E.delete(_)}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;T({isLoading:!1,isStreaming:!1,isContinuing:!1,initialStreamPromise:void 0,prefillOptions:{query:void 0,projectId:void 0},...c?{}:{activeForkKey:M,messages:s}}),k(_),(0,m.R)(e,Q,"Failed to submit message. Start a new chat, retry, or edit your message.")||o.Am.error("An unexpected error occurred. Please refresh the page and try again."),c||0!==s.length||Q.push("/chat")}},[r,M,W,G,_,T,U,z,V,Z,O,t,K,q,H,J,S,P,Q,D]),stopLlmResponse:(0,i.useCallback)(()=>{let e=W.current;if(k(_),e.length>0){let t=e[e.length-1];"assistant"===t.role&&T({messages:[...e.slice(0,-1),{...t,streaming:!1}]})}setTimeout(()=>T({isStreaming:!1,isLoading:!1}),0)},[_,W,T])}}function F(e,t){return t?"".concat(t.split("\n").map(e=>"> "+e).join("\n"),"\n\n").concat(e):e}}}]);